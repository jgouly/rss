<!DOCTYPE html>
<html lang="en">
    <head>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<style>
* {
  margin: 1%;
}
</style>
        <meta charset="utf-8">
        <title>wasm-string</title>
        <script type="javascript/worker" id="worker">
          var wasm_mod = null;
          var stack = [];
          self.onmessage = function(event) {
            solve_block(wasm_mod,  event.data);
          }
          function solve_block(results, scramble) {
              self.postMessage(new Date() + "\n");
           		const encoder = new TextEncoder();
           		let encodedString = encoder.encode(scramble);
          
               const a = results.instance.exports.stringPrepare(encodedString.length);
               const b = results.instance.exports.stringData(a);
          
               const asBytes = new Uint8Array(results.instance.exports.memory.buffer, b, encodedString.length);
           		asBytes.set(encodedString);
          
               const pointer = results.instance.exports.solve(a);
          
               const buffer = new Uint8Array(
                   results.instance.exports.memory.buffer,
                   pointer,
                   stack.pop()
               );
               self.postMessage(String.fromCharCode(...buffer));
               self.postMessage("\n" + new Date() + "\n");
          }
          var wasm_file = 'https://jgouly.github.io/rss/rss_wasm.wasm';
          fetch(wasm_file).then(response =>
                          response.arrayBuffer()
                      ).then(bytes =>
                          WebAssembly.instantiate(bytes,  {env: {
                  log_j: (num) => self.postMessage("Depth " + num + "\n"),
                  stack_push: (val) => stack.push(val),
                }})
                      ).then(results => {
                        wasm_mod = results;
          
               console.time("transition table");
               results.instance.exports.init_tables();
               console.timeEnd("transition table");
               self.postMessage("DONE");
               });
        </script>
<script>

var workerBlob = new Blob(
    [document.getElementById("worker").textContent],
    { type:'text/javascript' }
  );

var workerBlobUrl = URL.createObjectURL(workerBlob);
var worker = new Worker(workerBlobUrl);

worker.onmessage = function(event) {
  if (event.data == "DONE"){
    document.getElementById("solve_button").disabled = false;
    document.getElementById("log").textContent = "";
    return;
  }
  document.getElementById("log").innerHTML += event.data;
};
</script>
    </head>
<body>
<input type="text" size="100" id="scramble"></input>
<input type="button" value="Solve DL" id="solve_button" disabled onclick="document.getElementById('log').textContent='';worker.postMessage(document.getElementById('scramble').value);"></input>
<br />
<div rows="15" cols="100" id="log">LOADING...</div>
</body>
</html>
